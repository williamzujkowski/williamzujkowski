{# Dad joke ASCII box (fancy format) #}
{# Context: joke = { q, a, category }, timestamp, rotation, stats #}

{% set time = timestamp | slice(4, 16) if timestamp else 'Jan  1 00:00' %}
{% set groan_level = 80 + (rotation * 7) %}
{% set times_delivered = 10000 + (stats.daysAlive % 40000) %}
{% set success_rate = 95 + (rotation * 2) %}

{# Box inner width is 52 (56 - 4 for borders/padding) #}
{# Q: prefix is 3 chars, so max question text is 49 chars per line #}
{% set q_lines = joke.q | wrap(49, '   ') %}
{% set a_lines = joke.a | wrap(49, '   ') %}

{# Build question lines with Q: prefix on first line #}
{% set question_lines = [] %}
{% for line in q_lines %}
{% if loop.first %}
{% set question_lines = question_lines.concat(['Q: ' ~ line]) %}
{% else %}
{% set question_lines = question_lines.concat([line]) %}
{% endif %}
{% endfor %}

{# Build answer lines with A: prefix on first line #}
{% set answer_lines = [] %}
{% for line in a_lines %}
{% if loop.first %}
{% set answer_lines = answer_lines.concat(['A: ' ~ line]) %}
{% else %}
{% set answer_lines = answer_lines.concat([line]) %}
{% endif %}
{% endfor %}

{# Combine all sections #}
{% set joke_lines = [
  '',
  'DAD JOKE OF THE DAY - ' ~ time,
  'Category: ' ~ (joke.category | upper),
  ''
].concat(question_lines).concat(['']).concat(answer_lines).concat([
  '',
  'Stats:',
  '- Groan Level: ' ~ '|' | repeat(groan_level // 10) ~ ' ' ~ groan_level ~ '%',
  '- Times Delivered: ' ~ times_delivered,
  '- Success Rate: ' ~ success_rate ~ '% eye rolls',
  ''
]) %}

{{ joke_lines | box('double', 56) }}
